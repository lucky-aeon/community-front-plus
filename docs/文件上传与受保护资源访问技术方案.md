# 文件上传与受保护资源访问技术方案（前后端一体）

本文档阐述本项目的文件上传与受保护资源访问方案：后端签发直传凭证、前端直传 OSS、回调入库、受保护访问（Cookie 鉴权）与前端回显的完整链路，以及原因、权衡与运维要点。

## 目标与约束

- 直传至对象存储（阿里云 OSS），降低后端带宽与吞吐压力。
- 资源访问必须鉴权，后端需要记录“谁在何时访问了什么资源”。
- 前端 `<img>/<a>/window.open` 这类元素请求要流畅访问（天然不带 Bearer）。
- 统一“资源 ID 存储 + 客户端回显 URL”的使用体验。

## 总体架构

1) 获取上传凭证（后端）
- 前端调用 `POST /api/user/resource/upload-credentials`，后端根据业务生成 `fileKey`，请求 STS 临时凭证 + Policy + 签名 + 回调参数等，返回给前端。

2) 前端直传 OSS（不经过业务服务器）
- 前端构造 `FormData`，携带 `OSSAccessKeyId / policy / signature / key / x-oss-security-token / callback` 与 `file`，`POST` 到 `https://{bucket}.{endpoint}/`。
- 回调：OSS 将上传信息回调到业务后端 `POST /api/public/oss-callback`，后端校验并保存资源元数据（产生资源ID）。

3) 资源访问（受保护）
- 访问路径：`GET /api/public/resource/{resourceId}/access`。
- 鉴权：优先读取 HttpOnly Cookie（RAUTH），无则回退 Authorization Bearer；后端记录访问日志后，302 到短时效签名的 OSS URL。

4) 资源访问会话（Cookie）
- 颁发：`POST /api/user/resource/access-session`，从 Bearer 中识别用户，下发短时效 HttpOnly Cookie：`RAUTH`（Path=`/api/public/resource`，Max-Age=15min，SameSite=Lax，Secure=HTTPS）。
- 续签：`GET /api/user/heartbeat` 时重发同名 Cookie（滑动窗口），保证长时间播放/浏览不中断。

5) 前端回显与持久化
- 所有“资源字段”在接口返回中都可以是“资源ID”；前端统一通过工具 `toAccessUrl(id)` 转换为可展示的访问 URL。
- 表单侧（头像/封面等）保存资源ID，回显使用访问 URL（ID→URL 双通道）。

## 交互流程（时序）

上传：
1. 前端：`POST /api/user/resource/upload-credentials` → 获取凭证。
2. 前端：`POST https://{bucket}.{endpoint}/`（直传 OSS）。
3. OSS：回调 `POST /api/public/oss-callback`，业务入库并产生资源ID。
4. 前端：读取回调返回的 resource.id，立即回显（ID→URL），保存时传资源ID。

访问：
1. 登录后：前端调用 `POST /api/user/resource/access-session` 下发 RAUTH Cookie；后续心跳 `GET /api/user/heartbeat` 续签。
2. `<img src="/api/public/resource/{id}/access">` 访问时自动携带 Cookie；后端校验身份→记录→302 到 OSS 签名 URL。

## 关键接口定义（简化）

- 获取上传凭证：`POST /api/user/resource/upload-credentials`
  - 入参：`{ originalName: string, contentType: string }`
  - 出参：`{ accessKeyId, accessKeySecret, securityToken, policy, signature, key, callback, endpoint, bucket }`

- OSS 回调：`POST /api/public/oss-callback`
  - 入参：`{ filename, mimeType, size, ... }`
  - 出参：`{ Status: 'OK', resource: { id, fileKey, ... } }`

- 资源访问会话：`POST /api/user/resource/access-session`
  - 请求头：`Authorization: Bearer <token>`
  - 响应头：`Set-Cookie: RAUTH=<token>; HttpOnly; Path=/api/public/resource; Max-Age=900; SameSite=Lax; Secure`

- 心跳续签：`GET /api/user/heartbeat`
  - 请求头：`Authorization: Bearer <token>`
  - 响应头：同上 `Set-Cookie: RAUTH=...`（滑动续签）

- 资源访问：`GET /api/public/resource/{id}/access`
  - Cookie：`RAUTH`（优先）或 `Authorization: Bearer`（兜底）
  - 响应：302 → 签名 URL（短时效 2~5 分钟）

## 前端实现要点

- 直传实现：`AliyunUploadService.uploadFile`
  - 正确字段顺序、`success_action_status=200`、签名校验（WebCrypto HMAC-SHA1）
- 资源ID→URL：`ResourceAccessService.toAccessUrl(value)`
- 资源会话：
  - 登录/注册/初始化后调用 `ensureSession()`；心跳轮询（30s）时也调用；上传成功后再兜底调用一次。
  - 元素请求（img/a/open）会自动带 Cookie，无需额外处理。
- 表单：
  - 保存资源ID（如 `avatarResourceId` / `coverResourceId`）；回显使用 URL。
  - Create/Update payload 优先传资源ID，兼容传 URL（外链）。

## 后端实现要点

- 上传凭证与 Policy
  - 仅允许约束前缀 `key`、限制大小与类型；STS 临时凭证有效期短（如 30min）。
- 回调入库
  - 基于回调参数生成资源记录（id、fileKey、format、size、userId、type 等）。
- Cookie 鉴权
  - RAUTH 仅用于资源访问（Path 限定），TTL 短；生产开启 Secure 与 HTTPS；跨域慎用 SameSite=None。
  - 资源访问接口优先 Cookie，兜底 Bearer；均通过后记录访问日志（userId、resourceId、ip、ua、referer、time）。
  - 黑名单校验（被管理员下线后心跳 401，Cookie 将不再续签）。
- 302 跳转签名 URL
  - 生成短时效签名（2~5 分钟），避免泄漏长期可用直链。

## 为什么这样做

- 性能与成本：大文件走直传，不占用业务带宽，降低服务器吞吐与成本。
- 安全与审计：资源访问经由业务后端进行鉴权与审计（“谁访问了什么/何时/来源”）。
- 兼容性：`<img>/<a>` 原生请求不带 Bearer，使用 Cookie 鉴权最契合浏览器行为；心跳续签保证长时会话稳定。
- 可维护性：接口层统一使用“资源ID”，前端统一转换为 URL，隐藏对象存储细节，便于迁移与扩展（如换 CDN）。

## CORS / 跨域建议

- 同域优先：前端与 `/api` 同域，通过反向代理转发后端。
- 若必须跨域：
  - 允许 `Access-Control-Allow-Origin: <前端域>` 与 `Access-Control-Allow-Credentials: true`
  - 仅在 HTTPS 下使用 `SameSite=None; Secure`，并确保 Cookie 的 Domain/Path 与访问路径匹配。

## 安全要点

- 绝不在 URL 中携带 Bearer；Cookie 为 HttpOnly。
- STS 与 Policy 最小权限、短时效，不在日志中打印敏感字段。
- 资源访问日志聚合，便于风控审计；可配合频率限制与 Referer 防盗链。

## 未来扩展

- 分片上传与断点续传：适配大文件与弱网。
- CDN 与边缘缓存：签名 URL 与缓存策略结合，降低回源。
- 访问策略：按资源类型/所有者/套餐设定权限（如仅会员可访问）。

## 测试清单

- 上传：多类型/大尺寸/异常 MIME；回调入库是否正确。
- 访问：登录后 `<img>` 回显、下载；登出或 401 后是否拒绝；黑名单是否生效。
- 续签：播放/浏览 > 15min 期间是否稳定；心跳失败恢复逻辑。
- 跨域：Cookie 是否可写入/携带；元素请求是否带 Cookie。

---

如需查看实现：
- 前端：`src/shared/services/api/aliyun-upload.service.ts`、`resource-access.service.ts`、`upload.service.ts`、`AuthContext.tsx`。
- 后端（示例）：`ResourceController.createAccessSession`（签发 Cookie）、`PublicResourceController.access`（Cookie/Bearer 双通道 + 302 跳转）、`PublicResourceController.handleOssCallback`（回调入库）。

